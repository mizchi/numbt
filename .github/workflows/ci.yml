name: CI

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  test:
    strategy:
      matrix:
        include:
          - os: macos-latest
            link-flags: "-framework Accelerate"
          - os: ubuntu-latest
            link-flags: "-lopenblas -llapack -lm"
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install OpenBLAS and LAPACK (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y libopenblas-dev liblapack-dev
      - name: Configure link flags
        run: |
          sed -i.bak 's|-framework Accelerate|${{ matrix.link-flags }}|' src/moon.pkg
          cat src/moon.pkg
      - name: Install MoonBit CLI
        run: |
          curl -fsSL https://cli.moonbitlang.com/install/unix.sh | bash
          echo "$HOME/.moon/bin" >> "$GITHUB_PATH"
      - name: Moon update
        run: moon update
      - name: Configure blas dependency link flags (Linux)
        if: runner.os == 'Linux'
        run: |
          ls -la
          if [ -d .mooncakes ]; then
            find .mooncakes -name "moon.pkg" -exec sed -i 's|-framework Accelerate|-lopenblas -llapack -lm|g' {} \;
            find .mooncakes -name "moon.pkg" -exec cat {} \;
          else
            echo "No .mooncakes directory found, checking ~/.moon/registry"
            find ~/.moon/registry -name "moon.pkg" -path "*blas*" -exec sed -i 's|-framework Accelerate|-lopenblas -llapack -lm|g' {} \; 2>/dev/null || true
          fi
      - name: Moon check
        run: moon check --target native
      - name: Moon test
        run: moon test --target native
