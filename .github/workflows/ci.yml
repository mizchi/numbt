name: CI

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  test:
    # Linux support is experimental - LAPACK tests crash with SIGABRT
    # For now, only run on macOS where everything works
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Configure link flags
        run: |
          cat > src/moon.pkg << EOF
          import {
            "mizchi/blas" as @blas,
            "moonbitlang/core/math" as @math,
          }
          options(
            link: { "native": { "cc-link-flags": "-framework Accelerate" } },
            "native-stub": [ "numbt_stub.c" ],
            "supported-targets": [ "native" ],
          )
          EOF
          cat src/moon.pkg
      - name: Install MoonBit CLI
        run: |
          curl -fsSL https://cli.moonbitlang.com/install/unix.sh | bash
          echo "$HOME/.moon/bin" >> "$GITHUB_PATH"
      - name: Moon update
        run: moon update
      - name: Moon check
        run: moon check --target native
      - name: Moon test
        run: moon test --target native
